#cloud-config

# Cloud-init configuration for Jenkins CI/CD VM
# This file will automatically configure the VM on first boot

users:
  - name: grometis
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: [sudo, docker]
    lock_passwd: false
    # senha: grometis123 (hash gerado com: mkpasswd --method=SHA-512 --rounds=4096)
    passwd: "$6$rounds=4096$saltstring$VXlPzLpPxEiPbOWqRGJmOiM5LqJ8g7RjLuYdPkMZqCrC0CKdD1CfLSQwD9fDZs4g1Ys0VjQFh3JvH2K1Hs3Kp/"
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... # Será substituída pela chave pública real

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - software-properties-common
  - git
  - vim
  - wget
  - openjdk-11-jdk

runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  
  # Install Docker Compose standalone
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Add grometis user to docker group
  - usermod -aG docker grometis
  
  # Install Jenkins
  - wget -q -O /usr/share/keyrings/jenkins-keyring.asc https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
  - echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/" | tee /etc/apt/sources.list.d/jenkins.list > /dev/null
  - apt-get update
  - apt-get install -y jenkins
  
  # Add jenkins user to docker group
  - usermod -aG docker jenkins
  
  # Configure Jenkins to start on boot
  - systemctl enable jenkins
  - systemctl start jenkins
  
  # Configure Docker to start on boot
  - systemctl enable docker
  - systemctl start docker
  
  # Create directory for SSH keys
  - mkdir -p /home/grometis/.ssh
  - chmod 700 /home/grometis/.ssh
  - chown -R grometis:grometis /home/grometis/.ssh
  
  # Create directory for Jenkins workspace
  - mkdir -p /var/jenkins_home
  - chown -R jenkins:jenkins /var/jenkins_home
  
  # Wait for Jenkins to start and get initial admin password
  - sleep 30
  - echo "Jenkins initial admin password:" > /home/grometis/jenkins-initial-password.txt
  - cat /var/lib/jenkins/secrets/initialAdminPassword >> /home/grometis/jenkins-initial-password.txt 2>/dev/null || echo "Password not ready yet" >> /home/grometis/jenkins-initial-password.txt
  - chown grometis:grometis /home/grometis/jenkins-initial-password.txt

write_files:
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        }
      }
    permissions: '0644'

  - path: /home/grometis/docker-info.txt
    content: |
      Docker and Jenkins Installation Complete!
      
      Jenkins URL: http://192.168.15.6:8080
      
      To get the initial admin password, run:
      sudo cat /var/lib/jenkins/secrets/initialAdminPassword
      
      Or check the file:
      cat ~/jenkins-initial-password.txt
    permissions: '0644'
    owner: grometis:grometis

final_message: |
  Cloud-init setup complete!
  Jenkins is running on port 8080
  Docker and Docker Compose are installed
  System is ready for CI/CD pipeline
